需要实现的效果如下图，在一个光滑的大理石平面上反射出物体的镜像：

> ![img](BillboardReflection/1.jpg =400x)

一般来说类似这种水面反射的效果，会使用一个相对当前相机在平面另一边的一个镜面相机进行渲染到 RenderTexture，再投影到平面上的技术。这种方法好处是自由度很高，缺点是消耗也不小。而这里使用到方法，由于是针对一些特定情况设计的，所以应用场景就没那么广泛，当然消耗也会小很多。

从名称上就可以看出，被反射的物体只能是一个面片，当然是不是 Billboard 都可以，Billboard 也是面片嘛。这就是所谓的局限性了。如果使用得当可以得到非常好的效果，甚至可以用这种方法来模拟出面光源的效果：

> ![img](BillboardReflection/2.jpg =400x)

这种方法的基本原理就是计算射线和平面的交点：

> ![img](BillboardReflection/3.jpg =400x)
>
> V : 视线向量
> 
> N : 法线向量
> 
> R : 反射向量
> 
> P : 反射向量于面片的交点

使用以下方程来表示平面：

\\[
(P\_{x}-P\_{o}) \cdot P\_{N} = 0
\\]

> $$$ P\_{x} $$$ : 平面上任意一点
> 
> $$$ P\_{o} $$$ : 平面上另一个点
>
> $$$ P\_{N} $$$ : 平面的法向量

对于一个平面来说，$$$ P\_{x}-P\_{o} $$$ 最形成的向量与 $$$ P\_{N} $$$ 向量永远垂直，所以点积总是 $$$ 0 $$$。

使用以下方程表示射线：

\\[
R(t) = R\_{o} + R\_{D} * t
\\]

> $$$ R\_{o} $$$ : 射线的起点
>
> $$$ R\_{D} $$$ : 射线的方向
>
> $$$ t $$$ : 射线在方向上经过的距离

由于射线和平面有交点（暂不考虑没有交点的情况，可以通过 $$$ P\_{N} 和 R\_{D} $$$ 判断出来），所以可以直接将射线方程代入平面方程：

\\[\begin{align}
(R\_{o} + R\_{D} * t - P\_{o}) \cdot P\_{N} &= 0 \\\
{ (P\_{o} - R\_{o}) \cdot P\_{N} \over R\_{D} \cdot P\_{N} } &= t
\end{align}\\]

得到 $$$ t $$$ 之后，就可以将 $$$ t $$$ 代回射线方程，求出交点了。注意这个交点是在世界坐标下的，我们需要将其转换到要投影面片的模型坐标下，并转换成 uv 坐标，从要投影面片的纹理中采样。这就是完整的思路。

关键部分的代码其实就是将以上的公式翻译成代码即可。这里提供一个小技巧，在实现着色器代码的时候总是会出现各种意想不到的问题，这时候就很难调试了，我是先在脚本中将所有的计算都实现了一边，并使用 Gizmos 将过程以及结果以辅助线的形式绘制出来，确保无误后再移植到 Shader 中的。这样的好处就是方便调试，有什么问题立刻能看出来。