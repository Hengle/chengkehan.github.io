使用 Cubmap 可以模拟出环境的反射，预先将环境渲染到 Cubmap 中，从而避免在游戏运行时对环境的实时反射产生的消耗，而且这样做表现效果也非常好。在一些户外环境尤其适用，比如说车身反射外部的环境。但是在一些室内的环境中，普通的 Cubmap 反射通常会产生奇怪的效果。

> ![img](LocalCubmap/1.jpg =400x)

可以看到大理石地面的反射错了，这是普通计算 Cubmap 的反射射线方式所无法避免的。

	// 通过视线向量和法线向量计算反射向量
	float3 reflDir = reflect(viewDir, normal);
	// 使用反射向量采样 Cubmap
	fixed4 col = texCUBE(_EnvMap, reflDir);
	
当以相同的视角看地面时，得到的反射向量是不会发生变化的，所以地面上反射的 Cubmap 不会随着观察角度的不同而发生改变。一般我们认为 Cubmap 是一个无穷大的立方体包围着要产生反射的物体，上面的效果和这个假设是匹配的。于是我们使用一种新的方法来计算反射向量。

> ![img](LocalCubmap/2.jpg =400x)

图中，R 是使用上文中介绍的方法计算得到的反射向量，R 射线和假象的 Cubmap 范围盒交点于 P，再从产生 Cubmap 快照的点 B 到 P 形成的新的向量即是新的反射向量 NewR。这些步骤中最为关键的就是求出交点 P。

求交点 P 实际上就是在求射线和平面的交点。