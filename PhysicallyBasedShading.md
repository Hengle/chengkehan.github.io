#基于物理的着色（译）

**2016-5-?**

原文：[Background: Physically-Based Shading](http://renderwonk.com/publications/s2010-shading-course/hoffman/s2010_physically_based_shading_hoffman_a_notes.pdf) @ [SIGGRAPH 2010 Course: Physically-Based Shading Models in Film and Game Production](http://renderwonk.com/publications/s2010-shading-course/)

---

在这一篇教程中，我们会重温下基于物理着色背后的基本概念，从基于物理性质的描述开始，然后使用相关数学公式进行量化的描述，最后讨论下这些数学模型如何在着色器中实现。

###基于物理的着色

着色器背后的物理现象是有关于光和物质的之间的交互。理解了这些现象后，能让我们对光的本质有一个基本的认识。

>![img](PhysicallyBasedShading/1.jpg =300x)
>
>Figure 1: 光是电磁波

光是一种电磁波，它会垂直于它的传播方向来回震荡（Figure 1）。

由于光是一种波，波有一个波长的特性，波长是波顶到波顶之间的距离。电磁波长的范围非常广，但是只有一小部分（大约 400 到 700 纳米）是可见的，所以我们只关注这一可见的波分（Figure 2）。

>![img](PhysicallyBasedShading/2.jpg =400x)
>
>Figure 2: 可见光谱

光在物质上表现出的效果被定义为一种叫做折射率的属性。折射率是一个复数，它的实部表示物质如何影响光速（相对于真空减速多少），虚部表示光线在传播的时候是否被吸收（转化成其它形式的能量）。折射率和光波长函数有所不同。

###均匀的介质

最简单的情况是光物质在一个均匀的介质中传播。这部分介质物质有着恒定的折射指数（和光波长成一定的比例；这种情况下的可见光的任何变化远远小于100纳米或者忽略不计）。

>![img](PhysicallyBasedShading/3.jpg =400x)
>
>Figure 3: 光在透明的介质中传播（水、玻璃，左图），沿着直线并有着同样的强度和颜色（右图）（直线指的是在单一介质内部）。

透明的介质对于可见光波长会产生非常小的折射率。这意味着不会产生很大的吸收，光沿着直线传播穿过介质。透明的介质包括水和玻璃（Figure 3）。

如果均匀的介质在可见光谱范围内有很强的吸收率，它将会吸收一部分穿过它的光。穿过的距离越长，吸收的越多。然而光的方向并不会改变，只是强度会变弱。亦或是，吸收率有选择性的对于特定的可见光波长（不同的可见光波长对于眼睛来说就是不同的颜色）（Figure 4）。

>![img](PhysicallyBasedShading/4.jpg =400x)
>
>Figure 4: 光传沿着直线穿过透明、易吸收的介质（左图），但是随着距离增加强度变弱并变色（右图）。

通过观察介质物质的吸收率。例如，水实际上只吸收非常小的可见光，特别是在光谱的红端。在英寸级别是可以忽略不计的（Figure 3），但是超过几英尺后效果就变得非常明显了（Figure 5）。

>![img](PhysicallyBasedShading/5.jpg =400x)
>
>Figure 5: 在长距离之后，原本细微的吸收率变得非常明显。

###散射

在均匀的介质中，光总是持续沿着直线传播，不会改变方向（虽然强度会随着吸收变弱）。不同介质有着不同的折射率。如果折射率缓慢连续的变化，那么光线会弯曲成一个曲线。然而，如果折射率在短距离内（相对于波长）突然发生变化，那光会产生散射，分叉到多个方向上。注意散射并不改变总体光的数量。

一些微小的颗粒会造成反射率和周围产生差异。这就造成了光从任意可能的方向上散射出去（Figure 6）。注意散射光的传播在所有方向上都是一致的，不依赖于微粒的类型。有些是向前散射，有些是向后散射，有些在特定的方向上会产生更复杂的传播。

>![img](PhysicallyBasedShading/6.jpg =400x)
>
>Figure 6: 微粒导致光散射到任意方向上。

在哑介质中，散射强度足以产生随机光传播方向（Figure7）。在半透明或不透明的介质中，散射强度非常高，以至于光传播方向完全随机（Figure 8）。

>![img](PhysicallyBasedShading/7.jpg =400x)
>
>Figure 7: 光在哑介质中（左图）随着传播产生了随机的传播方向（右图）。

>![img](PhysicallyBasedShading/8.jpg =400x)
>
>Figure 8: 光在半透明或者不透明介质中（左图）随着传播方向变得完全随机（右图）。

吸收和散射程度都依赖于测量等级。像空气这种清晰的介质，它的散射是忽略不计的，但是当超过一定距离（几英里）后光散射就变得相当的可观了（Figure 9）。

>![img](PhysicallyBasedShading/9.jpg =600x)
>
>Figure 9: 即使是非常清晰的空气在经过几英里后也会产生相当大的散射。

###介质表现

上一节介绍了光和物质的两种不同的交互模式。物质的复数折射率部分会导致吸收，超过一定距离后，光的数量减少（如果吸收特定的波长也可能导致光的颜色发生改变），但是光的方向不会改变。另一方面，折射率的快速变化导致散射，光的方向发生改变（分叉到多个方向上），但是光的整体数量和光谱分布不会发生变化。还有第三种交互模式，发射，其他类型的能量产生了新的光（和吸收正好相反）。光源中会发生这种情况，但是在着色器中一般不会关心。

>![img](PhysicallyBasedShading/10.jpg =600x)
>
>Figure 10: 三种光和物质的交互模式：吸收、散射、发射。

大多数介质都在一定程度上散射和吸收光。每一种介质现象都取决于散射和吸收的相对数量。Figure 11 展示了介质的散射和吸收的不同的组合。

>![img](PhysicallyBasedShading/11.jpg =600x)
>
>Figure 11: 各种不同的光的散射和吸收的介质。

###在平面边界上的散射

Maxwell 方程组可以用来计算光在折射率发生改变时的光的行为，但是大多数情况下并不能很好的解决问题。只有在一种特定的情况下可行，这对着色来说有着重大的意义。这种情况就是在两种不同折射率物体之间的一个无限的、完美的平面边界。这对于描述一个物体表面来说非常棒，边界的一边是空气的折射率，另一边是物体的折射率。在这种特定情况下的Maxwell 方程组的解叫做 Fresnel 方程组。

>![img](PhysicallyBasedShading/12.jpg =600x)
>
>Figure 12: 折射率在平面边界的变化导致光散射到两个方向上。

虽然真实物体的表面并不是无限的，但是相比于光的波长来说确实可以这么认为。至于完美的平面，或许会有这样的反对声，就是没有物体的表面是真正平坦的。即使没有其他的东西，单独的原子也会形成微小尺度的隆起。然而和其它东西一样，这种隆起的规模和波长相比相差多少是至关重要的。在大小只有几百纳米的表面上确实会出现完美的平面，这种平面被称为光学平面，通常这被用在搞精度的光学仪器上，比如望远镜。

在这种特定的情况下，平面折射率边界，光不会散射到所有可能的方向上，而是分叉到两个确切的方向上：反射和折射（Figure 12）。

正如 Figure 12 所看到的，反射角等于入射角，但是和折射角不一样。折射角依赖于介质的折射率（ Snell 定律）。Fresnel 方程组描述了反射和折射的比例，这在下面会讨论到。

###非光学平面

当然，现实情况下大多数物体表面都不会像望远镜镜面一样的光亮。那么在非光学平面上会发生什么呢？大多数情况下，表面的确实有很多的不规整，这种不规整的程度比波长要大很多，但是又足够小以致无法察觉到（比一个像素还要小）。这种情况下，表面就像是由大量的微光学表面组成，看起来是很多不同朝向的小表面（Figure 13）。

>![img](PhysicallyBasedShading/13.jpg =600x)
>
>Figure 13: 肉眼能看到的非光学平面的反射光是由很多不同朝向的小的光学平面的反射光组成。

在这种观察级别下，越粗糙的表面，反射光看上去越模糊，因为从整体来看微表面朝向的差异更大（Figure 14）。

>![img](PhysicallyBasedShading/14.jpg =600x)
>
>Figure 14: 上面那张图，表面相对更平滑，微表面的朝向有些许差异，所以反射光的方向也只有一点差异，比较清晰的反射。下面的图中，表面比较粗糙，微表面的朝向差异比较大，所以反射光的方向也各不相同，反射效果也较模糊。注意从肉眼可见级别来说，上面两个都可以说是平滑的，我们这里讨论的粗糙差异是从微观的角度来考虑的。

在着色器中，通常统计对待这种微几何形态，并且认为表面的反射和折射光是在多个方向上（Figure 15）。

>![img](PhysicallyBasedShading/15.jpg =300x)
>
>Figure 15: 当从宏观上观察时，可以认为非光学平面的反射和折射光是在多个不同方向上的。

###次表面散射

折射的光线到底发生了什么呢？这依赖于物体的成分。金属在可见光谱上有这非常高的吸收率，所有被折射的光立刻被吸收了（被自由电子吸收）。非金属（也称为电介质或绝缘体）表现为均匀的介质，当光在其中折射时，呈现出吸收的范围，散射的行为就像我们前几节讨论的一样。大多数情况下，部分的折射光会发生足够多的散射次数，以至最后再次从同一个表面发射出去（Figure 16）。

>![img](PhysicallyBasedShading/16.jpg =600x)
>
>Figure 16: 左边的金属材质，所有的折射光能量迅速被自由电子所吸收。右边的非金属材质，折射光经过散射，知道再次被发射出表面（部分会被吸收）。

Figure 16 的右图中，你可以看到次表面散射的光线（蓝色的箭头）是从表面的不同点发射出去的，距离光线的射入点的距离也各不相同。Figure 17 展示了这种距离和像素尺寸的两种情况下的关系。左上图中，像素比次表面散射的入射点到出射点的距离还大，那么这段距离就可以被忽略，次表面散射光的出入点可以被假定为是同一点，如右上图所示。这就允许着色器将其作为一个完全局部的过程来处理：射出点依赖于相同位置上的射入点。Figure 17 下面的图中，像素比射入射出距离要小，这种情况下，每一个点的着色都会影响其他店的光照。为了得到这个效果，局部的处理是不够的，需要使用特殊的渲染技术。这种技术通常被称为次表面散射技术，但是需要注意普通的漫反射着色器也有这相同的物理现象的表现（折射光的次表面散射）。唯一的不同是散射距离相对于观察的级别。这个观察结果告诉了我们，在有一定观察距离时，材质通常会表现出可以用常规的漫反射着色来处理的次表面散射（比如有一定距离的一个角色的皮肤）。另一方面来说，当观察距离非常近的时候，材质被认为是表现出常规的漫反射着色会表现出次表面散射。

>![img](PhysicallyBasedShading/17.jpg =600x)
>
>Figure 17。

###着色中的数学

电磁辐射（包括可见光）的是使用辐射度来测量的。有各种不同的辐射量用来测量表面或方向上的光。我们一般只是关心用来量化光强度的沿着单一射线的辐照度（Radiance）。我们使用通用的辐照度标记 L 来表示辐照度，当对表面上一点着色时，$$$ L_i $$$ 表示即将到达表面的辐照度（射入），$$$ L_o $$$ 表示射出的辐照度。

辐照度（类似其它的辐射度量）是一个光谱量，是以不同波长为变量的一个函数。理论上来收，为了表现可见光的辐照度，需要存储一个连续的光谱分布。在一些特殊的渲染程序中确实需要密集的光谱采样，但是目前所有的产品级的渲染（电影和游戏），都使用 RGB 来代替。

### BRDF

着色在局部进行是最常见的假设（Figure 17）。这种情况下，表面上的一点如何影响光只依赖于射入光和射出光的方向。在这篇文档中，我们会使用 $$$ v $$$ 表示一个沿着射出放线的单位向量，$$$ l $$$ 表示一个射入方向反方向的单位向量（让所有的向量远离平面是为了计算方便）。光线对表面的影响使用一个叫做 BRDF 的函数来量化（Bidirectional Reflectance Distribution Function），使用 $$$ f(l,v) $$$ 来表示。每一个方向（射入、射出）都可以使用两个数字来表示（极坐标），所以 BRDF 的总体维度是 4。大多数情况下，围绕着法线旋转 $$$ l $$$ 和 $$$ v $$$ 不会影响 BRDF。这种各项同性的 BRDF 可以使用 3 个角来参数化（Figure 18）。实际情况中，参与到计算中的角的数量通常会从 1 到 5 个不等，一些常用的角如图 Figure 19。

>![img](PhysicallyBasedShading/18.jpg =600x)
>
>Figure 18：BRDF 依赖于射入和射出方向，可以使用四个角来参数化表示，如果是各项同性的话三个角表示。$$$ n $$$ 是表面的法线，$$$ l $$$ 是入射光方向向量，$$$ v $$$ 是射出方向向量，$$$ t $$$ 是切线向量（只有在各向异性中使用，当 $$$ l $$$ 和 $$$ v $$$ 绕着 $$$ n $$$ 旋转时，反射行为发生变化）。

>![img](PhysicallyBasedShading/19.jpg =600x)
>
>Figure 19: 在 BRDF 计算中，常用到的一些角度。

原则上，BRDF 只定义了光线 $$$ l $$$ 和观察 $$$ v $$$ 方向，另一方面，$$$ n \cdot l $$$ 和 $$$ n \cdot v $$$ 必须是非负数（两个单位长度的向量点乘等于这两个向量夹角的 $$$ cosine $$$ 值，如果是负数，说明夹角大于 90 度）。在着色器中，只有当需要表现超过 90 度范围的角度时，这种情况才会出现（例如，法线贴图可以让法线背向观察者）。一般都是将点乘结果钳位到 0。

BRDF 有两种直观的解释。第一种解释是，给定一个从某个角度的入射光线，BRDF 给出表面上所有射出方向上的反射和散射光的相对分布（Figure 20 右图）。第二种解释是，给定观察方向，BRDF 给出每一个射入方向上的对射出光线的相对贡献（Figure 20 左图）。

>![img](PhysicallyBasedShading/20.jpg =600x)
>
>Figure 20: 右图为第一种解释。左图为第二种解释。

BRDF 是一个光谱量。理论上输入和输出的波长需要额外的参数。然而，实际情况中，不同的波长之间是独立的，不会产生相互作用，每一个射出光的波长只受相同波长的射入光的影响。这就意味着我们使用更简单的光颜色来代替波长。

反射方程中使用的 BRDF：

\\[
L_o(v) = \int_\Omega f(l,v) \otimes L_i(l)(n \cdot l) d\omega_i
\\]

这个等式看起来很复杂，但其实非常简明：输出的辐照度等于输入的辐照度乘以 BRDF 以及一个 $$$ cosine $$$ 因子 的积分（表面上的所有方向）。如果你不太明白积分是什么，可以认为是一种连续的加权平均（译注：原文是 continuous weighted average，不明白为什么是加权平均，积分应该是连续极小量相加。补充知识，积分[^1]）。$$$ \otimes $$$ 符号表示各分量相乘，BRDF 和光颜色都是 RGB 向量。

[^1]:[https://www.mathsisfun.com/calculus/integration-introduction.html](https://www.mathsisfun.com/calculus/integration-introduction.html)

对于 BRDF 来说，并不是任意一个以射入射出方向为参数的函数都是有意义的。必须是物理合理的，所谓物理合理从两方面来考虑：互换性（reciprocity）和能量守恒。互换性简单来说就是，如果 $$$ l $$$ 和 $$$ v $$$ 进行交换，BRDF 的值不会改变：

\\[
f(l,v) = f(v,l)
\\]

能量守恒是指表面无法百分百的反射入射光的能量。数学上可以这样表达：

\\[
\forall l, \int_\Omega f(l,v)(n \cdot l) d\omega_o \leq 1
\\]

上面数学表达可解释为，对于任何可能的射入光 $$$ l $$$，BRDF 乘以一个 $$$ cosine $$$ 因子的积分，在射出方向 $$$ v $$$ 上必须不超过 1。

这个现象被 BRDF 描述为两条物理现象（对于非金属）：表面反射和次表面散射。由于每一个现象都有着不同的行为，所以通常 BRDF 将它们作为分开的项来处理。BRDF 描述表面反射的项通常叫做镜面反射项（Specular term），描述次表面散射的项叫做漫反射项（Diffuse term），Figure 21。

>![img](PhysicallyBasedShading/21.jpg =600x)
>
>Figure 21: BRDF 镜面反射项用来描述表面反射（黄色），BRDF 漫反射项描述次表面散射（蓝色）。

###表面反射（镜面反射项）

大多数基于物理的 BRDF 镜面反射项的基础是一个叫作微表面的理论。这个理论的建立是用来描述常规表面（非光学平面）的反射。微表面理论最基本的假设是常规表面是由很多微表面组成，这些微表面太小以至于无法看到。每一个小的微表面都被假设为一个光学平面。正如上一节所说的，光学平面将光改变到两个不同的方向上（反射和折射）。

每一个微表面根据法线 $$$ m $$$ 将入射光反射到确定的方向上。当计算 BRDF 时，光方向 $$$ l $$$ 和 观察方向 $$$ v $$$ 都是确定的。这就意味着常规表面上的成千上万个微表面中，只有那些正好将 $$$ l $$$ 反射到 $$$ v $$$ 的，才对 BRDF 是有贡献的。Figure 22 中，我们看到这些活动的微表面的法线 $$$ m $$$ 朝向正好在 $$$ l $$$ 和 $$$ v $$$ 的中间。这种正好在其它两个向量中间的向量，我们称为半向量（half-vector）或半角向量（half-angle vector），标记为 $$$ h $$$。 

>![img](PhysicallyBasedShading/22.jpg =600x)
>
>Figure 22: $$$ m=h $$$ 的微表面使得 $$$ l $$$ 反射到 $$$ v $$$。其它微表面没有对 BRDF 产生贡献。

也并不是所有的 $$$ m=h $$$ 的微表面都会对 BRDF 产生贡献，一些微表面会被其它微表面挡住（$$$ l $$$ 被挡住叫做 shadowing，$$$ v $$$ 被挡住叫做 masking）。微表面理论假设所有被挡住的光在镜面反射项中都会丢失，而实际情况中，由于光在多个表面间相互反射，最终又会变得可见，但是微表面理论并不考虑这些。通常情况下，这不会造成大的表现上的错误（粗糙的金属表面可能会有些异常）。光与微表面间的多种交互形式见 Figure 23。

>![img](PhysicallyBasedShading/23.jpg =600x)
>
>Figure 23：左图中，我们看到 $$$ l $$$ 方向的一部分光被遮挡住了，所以部分微表面在阴影中，无法接受到光（当然也无法反射光）。中间图，一些微表面对于观察者来说是不可见的，所以这些微表面反射的光是不会被看到的。这两种情况，微表面都不会对 BRDF 产生贡献。在实际情况中（右图），这些光并不会简单的消失，而是在微表面中相互反射，最终一部分会被反射到观察方向上。微表面理论忽略这种内部间的反射。

在这种假设下（光学平面和无内部反射），BRDF 的镜面反射项可以从第一个原理得出。BRDF 的微表面镜面反射项使用如下的公式：

\\[
f_{ufacet}(l,v) = { F(l,h)G(l,v,h)D(h) \over 4(n \cdot l)(n \cdot v) }
\\]

我们将会详细讲解公式中的每一项，但是现在先来个快速的总结。$$$ F(l,h) $$$ 是那些受到光照方向 $$$ l $$$ 和 法线 $$$ m=h $$$ 的活动的微表面的 Fresnel 反射。$$$ G(l,v,h) $$$ 是那些没有被遮挡住的微表面的比例。$$$ D(h) $$$ 是微表面法线分布函数（只对于活动的表面，也就是 $$$ m=h $$$的表面）。最后，分母上的 $$$ 4(n \cdot l)(n \cdot v) $$$ 是一个矫正因子，用来处理微表面局部空间和宏观表面的变换量。

### Fresnel 反射项

Fresnel 反射项计算光从光学平面反射的比例。这个值依赖于两件事：入射角（入射光线和法线的夹角）和材质的反射率。可见光谱中的发射率各不相同，为了制作上的方便，Fresnel 反射是一个光谱量（RGB）。我们同时知道，RGB 的每一个分量都在 0 到 1 之间，因为表面无法反射小鱼 0% 或者多余 100% 的入射光。而且我们只关心那些活动的微表面（$$$ m=h $$$），产生 Fresnel 反射的角度是在 $$$ l $$$ 和 $$$ h $$$ 之间。

完整的 Fresnel 方程组是相当复杂的，并且复杂的材质参数（可见光谱的复杂的反射率采样密度）对于艺术家来说不是很方便调整。然而通过这些方程组在真实世界材质的行为可以推导出一个这更方便的参数化的表达方式。有了这样的想法，我们来查看下 Figure 24。

>![img](PhysicallyBasedShading/24.jpg =600x)
>
>Figure 24:不同物质的不同的 Fresnel 反射。铜和铝在可见光谱上的反射率是有很大不同的，上图中反射表现为三调分开的曲线分别表示 RGB。铜的 R 曲线是最高的，然后是 G，最后是 B（因此总体是偏红的）。铝的 B 曲线是最高的，然后是 G，最后是 R。

图中所选择的材质表现出了很大的差异。尽管这样，任然能看到一些类似的东西。当入射角在 $$$ 0^o $$$ 到 $$$ 45^o $$$ 之间时，反射几乎是一个常量。反射在 $$$ 45^o $$$ 到 $$$ 75^o $$$ 之间变化较明显。在 $$$ 75^o $$$ 到 $$$ 90^o $$$ 之间反射率总是迅速的变到 1（如果用 RGB 表示，就是白色）。由于 Fresnel 反射在大部分范围内都是接近于 $$$ 0^o $$$ 的，所以我们把 $$$ F(0^o) $$$ 看做是材质的特征镜面反射。我们把这个值也看做是 0 到 1 之间的 RGB 颜色（就像其他值一样）。我们也会将这个值称为表面的镜面颜色，标记为 $$$ c_{spec} $$$。

$$$ c_{spec} $$$ 看起来是近似模拟 Fresnel 反射的一个理想的参数。并且 Schlik 也给出了一个高效且较为精确近似的方法：

\\[
F\_{Schlic} (c\_{spec},l,n) = c\_{spec} + (1 - c_{spec})(1 - (l \cdot n))^5
\\]

这个近似的算法在计算机图形中被广泛的使用。在我们当前活动微表面的情况中，需要使用 $$$ h $$$ 来代替表面法线 $$$ n $$$：

\\[
F\_{Schlic} (c\_{spec},l,n) = c\_{spec} + (1 - c_{spec})(1 - (l \cdot h))^5
\\]

为了知道到底将什么值分配给 $$$ c_{spec} $$$ 才是合理的，就需要观察下真实世界材质的 $$$ F(0^o) $$$ 时的值。这些值被列在了 Table 1 中。这些值是区分 Gamma(sRGB) 空间还是 Linear 空间的。

>![img](PhysicallyBasedShading/t1.jpg =600x)
>
>Table 1：各种材质当 $$$ F(0^o) $$$ 时的值。

当观察 Table 1 时，有几件显而易见的事。金属的 $$$ F(0^o) $$$ 值比非金属要大得多。铁是更偏黑色的金属，它在 $$$ 0^o $$$ 时反射超过 50% 的入射光。回想下金属不会产生次表面散射，金属只会产生明亮的镜面反射而不会产生漫反射。再看下钻石这种最亮的非金属，在 $$$ 0^o $$$ 的时候也只反射 17% 的入射光，大多数非金属的反射都要远远小于这个值。极少有材质的反射在 20% 到 40% 这个范围里，通常是一些半导体或者奇异的材质，很少会用到。同样，反射小于 2% 的也是极少的（水的 $$$ F(0^o) $$$ 的值）。总的来说，排除金属、宝石、结晶，差不多任何生活中常见的（实验室外的）材质的 $$$ F(0^o) $$$ 的值都在 2% 到 5% 之间。

###法线分布项

微表面的法线朝向并不是均匀分布的。微表面的法线越接近宏观表面的法线，就越倾向于表现为更高的频率。微表面法线的确切分布是由微表面法线分布函数(microfacet normal distribution function) $$$ D(m) $$$ 定义的。和$$$ F() $$$ 不同的是，$$$ D() $$$ 的值并不被限制在 0 到 1之间，虽然必须是非负数，但是可以是任意大的一个值。另一个与 $$$ F() $$$ 的不同是， $$$ F() $$$ 的值是一个 RGB，而 $$$ D() $$$ 的值是一个标量。在微表面的 BRDF 中，$$$ D() $$$ 负责计算 $$$ h $$$ 的方向，来决定有多少活动的微表面（$$$ m=h $$$）。这就是为为什么法线分布项会以 $$$ D() $$$ 这种形式出现在 BRDF 方程中。

$$$ D() $$$ 决定了镜面高光的尺寸、亮度以及形状。在图形学资料中有几种不同的法线分布函数，所有的都是类高斯（Gaussian）的方法，使用了类似粗糙度和其它一些参数（各项异性通常会有两个不同的参数）。当粗糙度减小的时候，微表面的法线 $$$ m $$$ 会更聚集到宏观表面法线周围，$$$ D() $$$ 的值会变得很高（在极限情况下，完美的镜面时，$$$ m=n $$$ 时，值为无穷大）。

###遮挡项（Shadowing-Making Term）

遮挡项 $$$ G(l,v,h) $$$ 在一些 BRDF 资料中被叫做几何项（Geometry Term）。$$$ G(l,v,h) $$$ 表明了给定法线 $$$ m $$$ 的微表面在光线入射方向 $$$ l $$$ 和观察方向 $$$ v $$$ 可以被观察到的可能性。在微表面 BRDF 中，是用 $$$ h $$$ 来代替 $$$ m $$$ 的（和前面介绍的原因类似）。由于 $$$ G() $$$ 项一种可能性，因此值是一个标量，并且被限制的 0 到 1 之间。和 $$$ D() $$$ 一样，在参考资料中有关于 $$$ G() $$$ 的各种分析描述，一般都是基于简单表面模型的近似。$$$ G() $$$ 通常不会使得 BRDF 引入任何新的参数，$$$ G() $$$ 没有参数，要么使用 $$$ D() $$$ 中表示粗糙度的参数。大多数情况下，遮挡项会抵消**等式4**中的分母 $$$ (n \cdot l)(n \cdot v) $$$，取而代之为其他的表达式，比如 $$$ max(n \cdot l, n \cdot v) $$$。

遮挡项对于 BRDF 的能量守恒来说是必不可少的，如果没有遮挡项，BRDF 会反射出任意多的光能量，比接受到的还要多。微表面 BEDF 的关键部分是表面总的区域和活动微表面所占的区域的比例。如果不关心遮挡项，活动区域会超过总区域，这就导致 BRDF 无法能量守恒（Figure 25）。

>![img](PhysicallyBasedShading/25.jpg =600x)
>
>Figure 25: 上图中，宏观表面用绿色标记，蓝色的表示凹凸不平的微表面，红色表示活动的微表面。宏观表面区域在观察方向上的的投影在左上角绿色线段表示。每个活动微表面的投影区域用分开的红色线段表示。左下图中，红色微表面区域相加但是并没有考虑遮挡，其结果是活动区域大于总区域。这是不合理的，BRDF 反射的能量比接受到的还要多。右下图中，可以看到使用一种考虑了遮挡的方式。叠加的部分不再被多次计算，活动区域小于总的区域。当观察角度更低的时候，这种对比就更明显了，忽略遮挡将导致 BRDF 反射的能量上千倍于接受的能量（当观察角度无限接近 $$$ 90^o $$$ 时，反射能量会变得无穷大）。

###微表面模型

方程 $$$ D() $$$ 和 $$$ G() $$$ 的选择都是相互独立的，对于不同的微表面模型可以任意的组合。大多数论文提出的新的 BRDF 模型，可以理解为在介绍新的 $$$ D() $$$ 和 $$$ G() $$$ 方程。

一旦 $$$ D() $$$ 和 $$$ G() $$$ 方程确定了，BRDF 就完全由选择的参数值决定了。微表面 BRDF 有着紧凑的参数，通常由一个 RGB 值（$$$ c_{spec} $$$使用）和一个（各项异性的话是两个）标量（粗糙度）组成，

###次表面散射（漫反射项）

尽管很多资料中介绍了多中次表面局部反射模型，但是使用最广泛的是 Lambertian BRDF。Lambertian BRDF 实际上是一个常量值，众所周知的 $$$ cosin $$$ 或者 $$$ (n \cdot l) $$$ 因子是反射等式的一部分，而不是 BRDF。Lambertian BRDF 的确切的值是：

\\[
f\_{Lambert}(l,v) = {c\_{diff} \over \pi}
\\]

$$$ c\_{diff} $$$ 是漫反射光照的一部分。就像 $$$ c\_{spec} $$$ 一样，这是一个使用 RGB 分量表示的值，并且限制在 0 到 1 之间，相当于大多数人认为的表面色。这个参数通常是指漫反射颜色。

Non-Lambertian 漫反射项试图模型化在掠射角（glancing angles）时镜面反射项和漫反射项的权衡，以及当规模大于散射距离时的表面粗糙度效果。

##实现着色

上一节中，我们知道了用来描述表面着色的数学模型。在这节中，我们讨论下如何将数学模型应用到电影和游戏产品的渲染中。

###一般光照（General Lighting）

大多数情况下， BRDF 必须是所有不同入射方向的光的积分。这说明要包含不仅仅是主光源，而且要有天光、场景中其他物体的精确的反射。为了完全解决这个问题，就需要全局光照（Global Illumination）算法。这个算法的描述超出了我们讨论的范围，更过的细节可以很多参考资料中找到，以及......

###精确光源（Punctual Light Sources）

通常产品级的光照环境是多个精确光源组成的。这些是一些经典的光源类型，点光、平行光、聚光（也有其他复杂的光源类型）。由于这些类型的光可以被设置为无穷小或者无穷亮，所以并不是物理真实的，但是大多数情况下确实可以得到合理的结果并且计算时比较方便。精确光源使用光颜色 $$$ c\_{light} $$$ 和 光方向 $$$ l\_{c} $$$ 作为参数，$$$ c\_{light} $$$ 并不相当于光强度的辐照度，而是当光方向和表面法线平行时（$$$ l\_c=n $$$）的 Lambertian 光照的白色。其它颜色量一样，$$$ c\_{light} $$$ 是一个 RGB 值，但是并不限制值的大小。

精确光源的一个重要的优势是可以将反射方程大大简化（方程1）。我们首先定义一个以 $$$ l\_c $$$ 为中心的小的区域光源，张角为 $$$ \varepsilon $$$。这个小的区域光根据入射辐照度方程 $$$ L\_{tiny}(l) $$$ 照亮一个着色的表面点。入射辐照度方程有以下两个属性：

\\[
\forall l \mid \angle (l,l\_c) > \varepsilon, L\_{tiny}(l) = 0 \\\
if \ l\_c = n, then \ c\_{light} = {1 \over \pi} \int_\Omega L\_{tiny}(l) (n \cdot l) d\omega_i
\\]

第一个属性是，任何入射光相对于 $$$ l_c $$$ 的角度都小于 $$$ \varepsilon $$$。也就是说任何相对 $$$ l_c $$$ 大于 $$$ \varepsilon $$$ 的入射光，不会产生任何光照。第二个属性遵循 $$$ c\_{light} $$$ 的定义，将 $$$ c\_{diff}=1 $$$ 应用于方程1（BRDF 反射方程）和方程7（漫反射项），并且使用 $$$ \varepsilon $$$ 趋于 0 的极限：

\\[
if \ l\_c = n, then \ c\_{light} = \lim\_{\varepsilon \to 0} \left( {1 \over \pi} \int_\Omega L\_{tiny}(l) (n \cdot l) d\omega_i \right)
\\]

因为 $$$ l_c = n $$$ 并且 $$$ \varepsilon \to 0 $$$，所以可以认为 $$$ (n \cdot l) = 1 $$$，于是得到：

\\[
c\_{light} = \lim\_{\varepsilon \to 0} \left( {1 \over \pi} \int_\Omega L\_{tiny}(l) d\omega_i \right)
\\]

需要注意的是，上式并不是特别用于 $$$ l_c $$$ 的，不局限于 $$$ l_c = n $$$，而是可以用于任何有效的入射光方向。重新调整下得到：

\\[
\lim\_{\varepsilon \to 0} \left( \int_\Omega L\_{tiny}(l) d\omega_i \right) = \pi c\_{light}
\\]

现在我们将小区域光照代入常规的 BRDF 中，并且看下 $$$ \varepsilon \to 0 $$$ 极限情况下的行为：

\\[
L\_o(v) = \lim\_{\varepsilon \to 0} \left( \int\_\Omega f(l,v) \otimes L\_{tiny}(l) (n \cdot l) d\omega\_i \right) = f(l\_c,v) \otimes \lim\_{\varepsilon \to 0} \left( \int\_\Omega L\_{tiny}(l) d\omega\_i \right) (n \cdot l\_c)
\\]

将方程12代入上式中，得到最终的精确光源方程：

\\[
L\_o(v) = \pi f(l\_c,v) \otimes c\_{light} \underline{ (n \cdot l\_c) }
\\]

相比于原来的反射方程，我们去除了积分并得到了一个简洁明了的 BRDF 方程，非常容易计算。注意 $$$ \underline{ (n \cdot l\_c) } $$$ 的下划线表示钳位 0，等同于 $$$ x = max(x, 0) $$$。这样背面的就不会任何的光照贡献。

平行光源（比如太阳）的 $$$ l\_c $$$ 和 $$$ c\_{light} $$$ 在整个场景中都是常量。而其他类型的光源，像是点光、射光等，都不是常量。$$$ c\_{light} $$$ 会随着距离的平方的倒数有相应的衰减，在实际情况中还会使用其他的衰减方程。

如果表面被多个精确光源照亮了，那么方程会被计算多次，并将多个结果相加。精确光源很少单独被使用，因为缺少来自其他方向的关照是很容易注意到的，特别是镜面表面。所以精确光源通常和其他类型的光照（环境光照）结合使用。